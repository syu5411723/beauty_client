import { __assign } from "tslib";
import { useRef, useMemo, useState, useCallback, } from 'react';
import { useDeepCompareEffect } from 'react-use';
import { DistortionEffectCarouselPlugin, } from './distortionEffectCarouselPlugin';
export function useDistortionEffectCarousel(_a) {
    var ref = _a.ref, images = _a.images, displacmentImage = _a.displacmentImage, _b = _a.initialIndex, initialIndex = _b === void 0 ? 0 : _b, backgroundSize = _a.backgroundSize, displacmentBackgroundSize = _a.displacmentBackgroundSize, commonAngle = _a.commonAngle, easing = _a.easing, intensity = _a.intensity, resizeDebounce = _a.resizeDebounce, speed = _a.speed, angle1 = _a.angle1, angle2 = _a.angle2, dpr = _a.dpr;
    var _c = useState(initialIndex), currentIndex = _c[0], setCurrentIndex = _c[1];
    // loadedImages[0] === true, indicates that the first image is loaded
    var _d = useState({}), loadedImages = _d[0], setLoadedImages = _d[1];
    var pluginRef = useRef(null);
    var defaultRef = useRef(null);
    var actualRef = ref || defaultRef;
    // deep compare becuase the images could pass as a new array every render
    useDeepCompareEffect(function () {
        // in this time, the ref should be populated
        if (!actualRef.current) {
            console.warn('ref is missing');
            return;
        }
        if (images.length === 0) {
            return;
        }
        var onImageLoaded = function (index) {
            setLoadedImages(function (prev) {
                var _a;
                return (__assign(__assign({}, prev), (_a = {}, _a[index] = true, _a)));
            });
        };
        var plugin = new DistortionEffectCarouselPlugin({
            initialIndex: initialIndex,
            images: images,
            displacmentImage: displacmentImage,
            parent: actualRef.current,
            backgroundSize: backgroundSize,
            displacmentBackgroundSize: displacmentBackgroundSize,
            commonAngle: commonAngle,
            easing: easing,
            intensity: intensity,
            resizeDebounce: resizeDebounce,
            speed: speed,
            onImageLoaded: onImageLoaded,
            angle1: angle1,
            angle2: angle2,
            dpr: dpr,
        });
        pluginRef.current = plugin;
        // this is necessary if the plugin was created before or the initialIndex is not valid
        setCurrentIndex(plugin.getCurrentIndex());
        // this is necessary if the plugin was created before
        setLoadedImages({});
        return function () {
            plugin.dispose();
            pluginRef.current = null;
        };
    }, [
        actualRef,
        displacmentImage,
        images,
        initialIndex,
        backgroundSize,
        displacmentBackgroundSize,
        commonAngle,
        easing,
        intensity,
        resizeDebounce,
        speed,
        angle1,
        angle2,
        dpr,
    ]);
    var next = useCallback(function () {
        var plugin = pluginRef.current;
        if (!plugin) {
            return;
        }
        plugin.next();
        setCurrentIndex(plugin.getCurrentIndex());
    }, []);
    var prev = useCallback(function () {
        var plugin = pluginRef.current;
        if (!plugin) {
            return;
        }
        plugin.prev();
        setCurrentIndex(plugin.getCurrentIndex());
    }, []);
    var jump = useCallback(function (index) {
        var plugin = pluginRef.current;
        if (!plugin) {
            return;
        }
        plugin.jump(index);
        setCurrentIndex(plugin.getCurrentIndex());
    }, []);
    return useMemo(function () { return ({
        currentIndex: currentIndex,
        next: next,
        prev: prev,
        jump: jump,
        ref: actualRef,
        loadedImages: loadedImages,
    }); }, [actualRef, currentIndex, jump, loadedImages, next, prev]);
}
